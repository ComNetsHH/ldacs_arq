\documentclass[a4paper]{article}
\input{definitions/packages.tex}
\input{definitions/commands.tex}
\input{definitions/acronyms.tex}
\usepackage{float}
\usepackage{rotating}
\usepackage{bm}
\usetikzlibrary{decorations.pathreplacing}

\addbibresource{IntAirNet.bib}

\renewcommand{\quote}[1]{``#1''}

\makeatletter
\renewcommand{\maketitle}{
	\pagenumbering{gobble}
	\begin{minipage}{0.49\textwidth}
		\begin{flushleft}\includegraphics[width=0.9\textwidth]{imgs/logos/logo_comnets.png}\end{flushleft}
	\end{minipage}	
	\begin{minipage}{0.49\textwidth}
		\begin{flushright}\includegraphics[width=0.8\textwidth]{imgs/logos/logo_tuhh.png}\end{flushright}
	\end{minipage}	
	\vspace*{1em}
	\begin{center}
		~\\[2em]
		{\huge{}Specification}
		\\[2em]
		{\Huge{}\@title}
		\\[3em]
		{\huge{}Inter Aircraft Network}
		\vfill
		
		% replace with correct logo
		\includegraphics[width=0.4\textwidth]{imgs/logos/bmwi.png}

		{\Large\@date}
		\vspace*{5em}
		
		\begin{minipage}[h][2em][b]{0.49\textwidth}
			\begin{flushleft}
				FÃ¶rderkennzeichen: 20V1708F
			\end{flushleft}			
		\end{minipage}
		\begin{minipage}[h][2em][b]{0.49\textwidth}
			\begin{flushright}
				Project Duration:\\01/2019 -- 03/2022
			\end{flushright}			
		\end{minipage}
		\noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}
		\begin{minipage}[h][6em][b]{0.44\textwidth}
			\begin{flushleft}
				\textbf{Work Package (WP) Leader:}\\Prof. Dr.-Ing. Andreas Timm-Giel
				\\
				\textbf{Partners:}\\DLR, Rohde \& Schwarz, NavCert, f.u.n.k.e., BPS, iAd
			\end{flushleft}
		\end{minipage}
		\begin{minipage}[h][6em][b]{0.54\textwidth}
			\begin{flushright}
				\textbf{Contributors:}\\\mbox{Sebastian Lindner, M.Sc.}\\\mbox{Konrad Fuger, M.Sc.}\\
\mbox{}\\
\mbox{}
			\end{flushright}
		\end{minipage}
	\end{center}
	\newpage
}
\hypersetup{
	pdftitle=TUHH Inter Aircraft Network Deliverable AP 2.2,
	pdfauthor=Hamburg University of Technology (TUHH)
}

\newcommand{\nr}{\texttt{seqno\_{}rx}}
\newcommand{\ns}{\texttt{seqno\_{}tx}}
\newcommand{\poll}{\texttt{poll}}
\newcommand{\srej}{\texttt{srej}}
\newcommand{\srejnum}{\texttt{srej\_{}num}}

\newcommand{\vr}{\texttt{V\_{}seqno\_{}rx}}
\newcommand{\vs}{\texttt{V\_{}seqno\_{}tx}}
\newcommand{\va}{\texttt{V\_{}seqno\_{}unack}}
\newcommand{\pr}{\texttt{V\_{}poll\_{}required}}
\newcommand{\srejr}{\texttt{V\_{}srej\_{}request\_{}list}}
\newcommand{\srejw}{\texttt{V\_{}srej\_{}waiting\_{}list}}
\newcommand{\rtx}{\texttt{V\_{}rtx\_{}list}}

\begin{document}
	\title{\quote{Avionic Automatic Repeat Request Protocol}}
	\date{October 2020}
	\maketitle
	
	\tableofcontents
	\newpage
	\pagenumbering{arabic}
	
	\section{Introduction}
	To establish reliable communication between IntAirNet hosts, an \ac{arq} protocol is used. 
	The following provides a specification od the protocol as well as the documentation of the implementation in the simulator.

	\subsection{Description}
	To obtain maximal channel utilization, the IntAirNet \ac{arq} is a version of selective repeat \ac{arq} and therefore aims to only retransmit segments which are explicitly not received.
	To do so, the \ac{arq} protocol uses cumulative \acp{ack} as well a selective rejection list to indicate \ac{nack} of segments which have not been received.

	\subsection{Architecture}
	The \ac{arq} is a link layer sublayer which resides between the \ac{mac} and the \ac{rlc} layer.
	Every transmission is initiated by the \ac{mac} layer.
	For this purpose the \ac{mac} layer monitors the buffer status of both \ac{rlc} and \ac{arq} layer and establishes transmission oppurtunities accordingly.
	Whenever a transmssion oppurtunity arrives, the \ac{mac} layer will request a segment from \ac{arq} layer which will either return an unacknowledged segment for retransmission or in turn request a new segment from the \ac{rlc} layer.


	\subsection{Header Fields}\label{sec:arq_header}
		The following header fields are required for the operation of the \ac{arq} protocol.		
		
		\begin{description}
			\item[\nr{}] The \quote{next sequence number to receive} field \nr{} carries the \emph{next} expected sequence number at the sender of this message.
			This acknowledges the reception of all sequence numbers up to $\nr{}-1$.
			
			\item[\ns{}] The transmit sequence number is the sequence number of the current segment that is being transmitted.
			
			\item[\poll{}] The poll field is set to an offset in the number of slots reserved for this communication link.
			The slot denotes a moment in time at which an \ac{ack} is requested at the latest.
			If a reverse link is configured, the remote end will piggyback its \acp{ack} onto each transmission.
			The slot denoted by the field is updated every time a segment is received.
			If \acp{ack} continue to arrive on the reverse link, then the respective slot will never be reached.
			If it is reached, then \acp{ack} stopped arriving or a reverse link is not configured or broke off.
			In this case, the respective slot is used for the remote end to send an \ac{ack}, and the local end abstains from transmission.	
			
			\item[\srejnum{}] The \texttt{srej\_{}num} field contains the number of entries in the \srej{} field.
			
			\item[] The \srej{} field contains as many sequence numbers as specified in the \texttt{srej\_{}num} field.
			Each sequence number is consequently \ac{nack}'d and should be scheduled for retransmission.
		\end{description}
		
	\subsection{System Variables}\label{sec:arq_variables}		
		The following system variables must be maintained at an \ac{arq} instance.			
		
		\begin{description}
			\item[\vs{}] The \vs{} variable contains the sequence number of the next in-order segment to be transmitted.
			
			\item[\vr{}] The \vr{} variable contains the sequence number of the next in-order segment expected to arrive.
			
			
			\item[\va{}] The \va{} variable contains the sequence number of the oldest un-acknowledged segment.
			
			\item[\pr{}] Number of slots when a \poll{} is required.
			
			\item[\srejr{}] List of segments that were detected as missing but not yet requested.
			
			\item[\srejw{}] List of segments that were detected as missing and requested but could not be \ac{ack}'d yet.
			
			\item[\rtx{}] List of segments that are currently required to be retransmitted.
		\end{description}
		
	\subsection{Sending data segments}\label{sec:arq_sending}
		Data segments are used to send new data or to retransmit lost segments.
		For new data the segment is assigned the sequence number from the \vs{} variable.
		The \vs{} variable is then incremented.
		For retransmitted data, the segment is assigned its original sequence number and the \vs{} is not affected.
		
		Generally, responses to the remote end take priority over other sending activities.
		This is to ensure that each \ac{pdu}'s packet delay is minimal, as application requirements might discard packets that take too long.
		Also, stalls are to be avoided when a sending window is exhausted.
		Therefore missing segments should be retransmitted and acknowledged as quickly as possible.
		
		Notifying the remote end of missing segments takes highest priority.
		If the \srejr{} list is not empty, then as many sequence numbers from it as fit are put into the \srej{} field and the number into the \srejnum{} field.
		These sequence numbers are then moved from the \srejr{} list into the \srejw{} list.
		The remaining capacity may be used for new data transmission.
		
		The next priority is to send outstanding retransmissions.
		Each item in the \rtx{} list is checked: if the number of attempted retransmissions exceeds the maximum allowed, then the segment is discarded.
		The current segment is given a header with a sequence number of the corresponding segment, but the data field is left empty.
		
		When new data is sent, the \poll{} field is filled with the current value of \pr{}.
		This variable is then updated to the end of the sending window minus $1$ ($\text{\va} + \frac{N}{2}-2$) unless it is already set to a smaller value.
		
	\subsection{Receiving data segments}\label{sec:arq_receiving}
		Upon reception, a segment's \ns{} header field is compared to the local \vr{} variable: $\vr{} - 1 + \frac{N}{2} - 1 \geq \ns{} \geq \vr{}$ should hold.
		Also the \nr{} field is checked for validity: $\vs{} \geq \nr{} \geq \va{}$ should hold.
		If either check fails, then the segment is discarded as invalid.
		
		If the segment's sequence number is identical to the next expected segment \vr{}, then it is passed into the reassembly buffer, and \vr{} is incremented.
		The current segment is removed if present from both the \srejr{} and \srejw{} lists.
		Next the reception buffer is checked for contiguous segments.
		All contiguous segments are added to the reassembly buffer and \vr{} is incremented accordingly.
		
		If the segment is not the next expected segment, then it is added to the reception buffer.
		A scheduled retransmission request is canceled by removing this segment from both the \srejr{} and \srejw{} lists.
		All sequence numbers between the highest previously received segment and the current segment are now deemed as missing and are added to the \srejw{} list, if not already on that list.
		
	\subsection{Poll time slot arrives}\label{sec:arq_poll}
		When the time slot at which a poll is requested arrives, then all sequence numbers from the \srejw{} list are transferred to the \srejr{} list, i.e. all missing segments are re-requested.
		All sequence numbers from the \srejr{} list are put into the \srej{} field, and \srejnum{} is set to the length of \srejr{}.
		The \nr{} and \ns{} fields are set to \vr{} and \vs{} as usual.
		This is an explicit \ac{ack}, so retransmission information has priority over user data.
		Remaining capacity may be filled with user data.		
			
	\appendix
	\section{References}
		\printbibliography[heading=none]
	
\end{document}